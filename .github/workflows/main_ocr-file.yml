name: Build and deploy Python app to Azure Web App - ocr-file

on:
  push:
    branches: [ main ]
  workflow_dispatch:

# ðŸš¦ Serialize deploys (don't kill the one that's building)
concurrency:
  group: ocr-file-production
  cancel-in-progress: false

permissions:
  contents: read

env:
  APP_NAME: ocr-file
  PYTHON_VERSION: '3.11'
  SITE_PACKAGES: .python_packages/lib/site-packages
  STARTUP_COMMAND: "gunicorn --bind 0.0.0.0:8000 app:app"  # change for Django/FastAPI

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: requirements.txt

      - name: Vendor dependencies into artifact
        run: |
          python -m pip install --upgrade pip
          mkdir -p $SITE_PACKAGES
          pip install -r requirements.txt -t $SITE_PACKAGES
          # Optional: sanity import check
          python - <<'PY'
          import pkgutil, sys
          print("Vendored packages:", len(list(pkgutil.iter_modules([".python_packages/lib/site-packages"]))))
          PY

      # Optional: Django collectstatic or DB migrations could go here (build-time only)
      # - name: Django collectstatic
      #   run: python manage.py collectstatic --noinput

      - name: Create deploy package (Run-From-Package friendly)
        run: |
          zip -r build.zip . \
            -x ".git/**" ".github/**" ".venv/**" "**/__pycache__/**" "**/*.pyc" "**/*.log"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: build.zip
          if-no-files-found: error
          retention-days: 7

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: .

      # Ensure app settings to avoid Oryx/Kudu builds and run from zip
      - name: Set App Service settings (no server builds, run from package, startup command)
        uses: azure/appservice-settings@v1
        with:
          app-name: ${{ env.APP_NAME }}
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_06D00263B7A6480C8C21DA4DE93B2EE7 }}
          app-settings-json: |
            [
              {"name":"SCM_DO_BUILD_DURING_DEPLOYMENT","value":"false"},
              {"name":"WEBSITE_RUN_FROM_PACKAGE","value":"1"},
              {"name":"STARTUP_COMMAND","value":"${{ env.STARTUP_COMMAND }}"}
            ]

      - name: Deploy ZIP (no Oryx)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.APP_NAME }}
          slot-name: 'Production'
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_06D00263B7A6480C8C21DA4DE93B2EE7 }}
          package: build.zip
